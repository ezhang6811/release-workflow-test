name: Test GitHub Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: The version to tag the release with, e.g., 1.2.0
        required: true
        default: "1.0.0-test"

env:
  ARTIFACT_NAME: aws_opentelemetry_distro-${{ github.event.inputs.version }}-py3-none-any.whl

permissions:
  contents: write

jobs:
  mock-artifacts:
    runs-on: ubuntu-latest
    outputs:
      layer-note: ${{ steps.layer-note.outputs.layer-note }}
    steps:
      - name: Create mock SDK artifact
        run: |
          echo "Mock SDK content" > ${{ env.ARTIFACT_NAME }}
      
      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
      
      - name: Create mock layer artifact
        run: |
          echo "Mock layer content" > layer.zip
      
      - name: Upload layer artifact
        uses: actions/upload-artifact@v4
        with:
          name: layer.zip
          path: layer.zip
      
      - name: Generate mock layer note
        id: layer-note
        run: |
          cat > layer-note.md << EOF
          | Region | Layer ARN |
          |  ----  | ----  |
          | us-east-1 | arn:aws:lambda:us-east-1:123456789012:layer:AWSOpenTelemetryDistroPython:1 |
          | us-west-2 | arn:aws:lambda:us-west-2:123456789012:layer:AWSOpenTelemetryDistroPython:1 |
          EOF
          
          {
            echo "layer-note<<EOF"
            cat layer-note.md
            echo "EOF"
          } >> $GITHUB_OUTPUT

  publish-github:
    needs: mock-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo @ SHA - ${{ github.sha }}
        uses: actions/checkout@v4
      
      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
      
      - name: Download layer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: layer.zip

      # Publish to GitHub releases
      - name: Create GH release
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create mock pyproject.toml for dependency extraction
          mkdir -p aws-opentelemetry-distro
          cat > aws-opentelemetry-distro/pyproject.toml << EOF
          [project]
          dependencies = [
              "opentelemetry-api == 1.21.0",
              "opentelemetry-sdk == 1.21.0",
              "opentelemetry-instrumentation == 0.42b0"
          ]
          EOF

          # Extract all dependencies from pyproject.toml
          DEPS=$(python3 -c "
            import re
            with open('aws-opentelemetry-distro/pyproject.toml', 'r') as f:
                content = f.read()
            deps_match = re.search(r'dependencies\s*=\s*\[(.*?)\]', content, re.DOTALL)
            if deps_match:
                deps_content = deps_match.group(1)
                dep_lines = re.findall(r'\"([^\"]+)\"', deps_content)
                formatted_deps = []
                for dep_line in dep_lines:
                    if ' == ' in dep_line:
                        package, version = dep_line.split(' == ', 1)
                        formatted_deps.append(f'- \`{package}\` - {version}')
                    else:
                        formatted_deps.append(f'- \`{dep_line}\`')
                print('\n'.join(formatted_deps))
          ")

          # Extract CHANGELOG entries for this version
          # CHANGELOG_ENTRIES=$(python3 -c "
          #   import re
          #   with open('CHANGELOG.md', 'r') as f:
          #       content = f.read()
          #   version_pattern = r'## v${{ github.event.inputs.version }}.*?\n(.*?)(?=\n## |\Z)'
          #   version_match = re.search(version_pattern, content, re.DOTALL)
          #   if version_match:
          #       entries = version_match.group(1).strip()
          #       if entries:
          #           print(entries)
          # ")

          # Create release notes
          cat > release_notes.md << EOF
          # $(if [ -n "$CHANGELOG_ENTRIES" ]; then echo "## What's Changed"; echo "$CHANGELOG_ENTRIES"; echo ""; fi)This release contains the following upstream components:

          $DEPS

          This release also publishes to public ECR and PyPi.
          * See ADOT Python auto-instrumentation Docker image v${{ github.event.inputs.version }} in our public ECR repository:
          https://gallery.ecr.aws/aws-observability/adot-autoinstrumentation-python
          * See version ${{ github.event.inputs.version }} in our PyPi repository:
          https://pypi.org/project/aws-opentelemetry-distro/

          This release also includes the AWS OpenTelemetry Lambda Layer for Python version ${{ github.event.inputs.version }}-$(echo $GITHUB_SHA | cut -c1-7).

          Lambda Layer ARNs:
          ${{ needs.mock-artifacts.outputs.layer-note }}
          EOF

          shasum -a 256 ${{ env.ARTIFACT_NAME }} > ${{ env.ARTIFACT_NAME }}.sha256
          shasum -a 256 layer.zip > layer.zip.sha256

          gh release create --target "$GITHUB_REF_NAME" \
             --title "Release v${{ github.event.inputs.version }}" \
             --notes-file release_notes.md \
             --draft \
             "v${{ github.event.inputs.version }}" \
             ${{ env.ARTIFACT_NAME }} \
             ${{ env.ARTIFACT_NAME }}.sha256 \
             layer.zip \
             layer.zip.sha256
